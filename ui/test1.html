<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="icon" type="image/png" href="/logo-sm.png" />
    <link rel="stylesheet" href="css/style.css">
    <title>Campus Laundry</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <header>
        <nav class="header__nav">
          <div class="header__logo">
            <img src="assets/Logo.png" alt="logo" />
            <div class="header__logo-overlay"></div>
          </div>
  
          <ul class="header__menu" data-aos="fade-down">
            <li>
              <a href="/">Home</a>
            </li>
            <li>
              <a href="/#menu">Membership</a>
            </li>
            <li>
              <a href="/#food">WHY US</a>
            </li>
            <li>
              <a href="/#services">CONTACT US</a>
            </li>
            <li>
              <a href="">Login</a>
            </li>
          </ul>
  
          <ul class="header__menu-mobile" data-aos="fade-down">
            <li>
              <img src="/assets/menu.svg" alt="menu" />
            </li>
          </ul>
        </nav>
    </header>

    <br>
    <br>
    <div class="container-fluid">
        <div class="div">
            <img src="assets/Trees-Pattern.png" class="img-fluid" alt="img">
        </div>
        <br>
        <br>
        <div id="messageBox" class="alert" style="display: none;"></div>
        <div class="container">
            <h2 style="color: #0099FF;">Address Book</h2>
            <br>  <br>
            <div class="form-group">
                <label for="addressInput">Add New Address</label>
                <input type="text" id="addressInput" class="form-control" placeholder="Start typing your address...">
                <div id="addressList" class="list-group"></div>
                <br>
                <button id="saveAddress" class="btn btn-primary" disabled>Save Address</button>
            </div>
            <br>
            <h3>Your Addresses:</h3>
            <div id="storedAddresses"></div>
        </div>
    </div>

    <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1/dist/es-module-shims.min.js" crossorigin="anonymous"></script>
    <script type="importmap">
    {
        "imports": {
            "@popperjs/core": "https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js",
            "bootstrap": "https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.esm.min.js"
        }
    }
    </script>
    <script type="module">
      import * as bootstrap from 'bootstrap'
      new bootstrap.Popover(document.getElementById('popoverButton'))
    </script>

    <script>
        const addressInput = $('#addressInput');
        const addressList = $('#addressList');
        const saveButton = $('#saveAddress');
        const storedAddresses = $('#storedAddresses');
        let selectedAddress;
        const headers = {
            'Content-Type': 'application/json'
        };

        function fetchAddresses() {
            fetch('http://127.0.0.1:5000/campus-laundry/cl_get_customer_address', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ "customer_id": 2 }) // Replace with the actual user ID
            })
            .then(response => response.json())
            .then(data => {
                const addresses = data.results.map(result => result.address);
                storedAddresses.empty();
                addresses.forEach(address => {
                    storedAddresses.append($('<p>').text(address));
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        addressInput.on('input', function () {
            const inputText = addressInput.val();
            if (inputText.length > 2) {
                fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/suggest?text=${inputText}&f=json&countryCode=CAN&outFields=*`)
                .then(response => response.json())
                .then(data => {
                    addressList.empty();
                    data.suggestions.forEach(suggestion => {
                        const listItem = $('<a>').addClass('list-group-item list-group-item-action').text(suggestion.text);
                        listItem.click(function () {
                            addressInput.val(suggestion.text);
                            addressList.empty();
                            fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?magicKey=${suggestion.magicKey}&outFields=StAddr,City,Region,CntryName,Postal,PostalExt,X,Y&f=json`)
                            .then(response => response.json())
                            .then(data => {
                                selectedAddress = data.candidates[0];
                                saveButton.prop('disabled', false);
                            });
                        });
                        addressList.append(listItem);
                    });
                });
            }
        });

        saveButton.click(function () {
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; 
            const targetUrl = `http://127.0.0.1:5000/campus-laundry/cl_set_customer_address`;
            fetch(proxyUrl + targetUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    "customer_id": 2, // Replace with the actual user ID
                    "address": selectedAddress
                })
            })
            .then(response => {
                if (response.ok) {
                    addressInput.val('');
                    fetchAddresses();
                    $('#messageBox').removeClass('alert-danger').addClass('alert-success').text('Address added successfully').fadeIn().delay(3000).fadeOut();
                } else {
                    throw new Error('Error adding address');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('#messageBox').removeClass('alert-success').addClass('alert-danger').text('Error adding address').fadeIn().delay(3000).fadeOut();
            });
        });

        // Fetch the existing addresses when the page loads
        fetchAddresses();
    </script>
</body>
</html>
